# AI Copilot Instructions for Messagerie App

## Architecture Overview

**Messagerie App** is a real-time secure messaging platform with image sharing and automatic expiration. It uses a **monorepo structure** with:

- **Backend**: Express.js + Socket.io + PostgreSQL (with Sequelize ORM)
- **Frontend**: Vanilla JavaScript with service workers (PWA support)

Key architectural pattern: **Separation of concerns** with dedicated services (socketService, cleanupService, imageService) rather than business logic in controllers.

## Critical Data Flows

### Message Lifecycle
1. **Send**: Frontend → HTTP POST `/api/messages` → Controller validates & stores in DB → Socket.io broadcasts to recipient
2. **Image Messages**: Images stored in `uploads/` directory with UUID filename; references stored in `Message.imageUrl`
3. **Expiration**: `cleanupService` periodically deletes images after viewing; frontend marks `imageViewed: true` via Socket event

### User Authentication
- **JWT Token Pattern**: `Bearer token` in Authorization header (verified in [auth.js](auth.js))
- **User Roles**: `ADMIN` and `USER` (from constants) with role-based middleware in routes
- **User Status**: Profiles can be `pending` (awaiting admin approval), `approved`, or `rejected`

### Real-time Communication
- **Socket.io Events**: Defined in [constants.js](backend/utils/constants.js#L200+) (e.g., `CONNECTION`, `USER_CONNECT`, `CONVERSATION_JOIN`, `MESSAGE_SEND`)
- **Rooms**: Conversations use rooms generated by `generateRoomId()` for private messaging
- **Online Status**: Tracked via `connectedUsers` Map in [socketService.js](backend/services/socketService.js)

## Project-Specific Conventions

### Error Handling
- **Centralized error codes**: Use `HTTP_STATUS` and `SERVER_MESSAGES` from [constants.js](backend/utils/constants.js)
- **Pattern**: Always return `{ success: boolean, message: string, data?: any }` in API responses
- **Global handler**: [errorHandler.js](backend/middleware/errorHandler.js) middleware catches all errors

### Database
- **PostgreSQL** with connection pool (max 5 connections in [database.js](backend/config/database.js))
- **Sequelize ORM**: Models use `timestamps: true` automatically (createdAt, updatedAt)
- **Soft delete disabled** (paranoid: false) — use explicit deletion or soft-delete flags
- **Relations**: User → Messages (one-to-many); ensure `onDelete: CASCADE` for foreign keys

### Frontend API Calls
- **Centralized client**: [api.js](frontend/js/api.js) exports `API` object with methods like `API.messages.send()`, `API.auth.login()`
- **Token management**: Tokens auto-attached via `_getToken()` in requests; refresh happens server-side
- **Offline support**: Service workers and localStorage cache responses for PWA functionality

### Code Organization
- **Controllers**: Business logic only; no DB queries directly (use models)
- **Routes**: Define endpoints and attach middleware (auth, validation) — see [routes/index.js](backend/routes/index.js)
- **Middleware**: Reusable logic (auth.js, validation.js, rateLimiter.js in [middleware/](backend/middleware/))
- **Services**: Complex operations isolated (e.g., image upload handling in [imageService.js](backend/services/imageService.js))

## Developer Workflows

### Setup & Database
```bash
npm run install:all          # Install root + backend dependencies
npm run db:init             # Create PostgreSQL schema
npm run db:migrate          # Apply profile migration
npm run db:seed             # Load test data
npm run db:reset            # Full reset (init + migrate + seed)
```

### Development
```bash
npm run dev                 # Start backend with nodemon hot-reload
npm run lint                # Run ESLint
npm run lint:fix            # Auto-fix linting issues
npm run format              # Prettier formatting
npm test                    # Jest tests with coverage
```

### Important Config Files
- **.env**: Database credentials, JWT secret, Socket.io timeouts, image upload paths
- [package.json](backend/package.json) scripts section: All test/lint/build commands
- [.eslintrc.json](backend/.eslintrc.json): Linting rules (Node.js + Jest environment)

## Key Integration Points

### Adding New Messages Routes
1. Create endpoint in [routes/messages.js](backend/routes/messages.js)
2. Add controller method in [controllers/messageController.js](backend/controllers/messageController.js)
3. Emit Socket event via `socketService.io.emit()` or use room broadcast
4. Test both HTTP response AND Socket event emission

### Handling Image Uploads
- Multer config in [config/multer.js](backend/config/multer.js) (limits: 5MB, JPEG/PNG only)
- Images stored as UUID filenames; delete via [imageService.js](backend/services/imageService.js)
- Frontend sends multipart/form-data; backend returns `imageUrl` path in response

### Admin Routes
- All admin endpoints protected by [admin.js](backend/routes/admin.js) middleware checking `role: 'admin'`
- Admin can approve/reject pending user profiles (status in [User.js](backend/models/User.js) model)

## Common Pitfalls to Avoid

1. **Database calls without error handling**: Always use try-catch or `.catch()` in Sequelize queries
2. **Missing JWT in Socket.io authentication**: Socket events should verify token manually or use middleware
3. **Image cleanup timing**: Don't delete images synchronously; use `cleanupService` scheduled tasks
4. **CORS misconfiguration**: Check `process.env.CORS_ORIGIN` matches frontend URL in [server.js](backend/server.js#L53)
5. **Rate limiting bypass**: Apply `rateLimiter` middleware to sensitive endpoints (auth, messages)

## Testing & Validation

- **Validation middleware**: [validation.js](backend/middleware/validation.js) uses schema validators before controller
- **Message validation**: Max 5000 chars for content (see [Message.js](backend/models/Message.js#L38))
- **Image validation**: Required fields in multipart upload checked by Multer + [imageService.js](backend/services/imageService.js)
